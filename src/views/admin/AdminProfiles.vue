<template>
  <BoxLoader :show="true">
    <div class="max-w-screen-lg mx-auto space-y-6">
      <BreadcrumbsBar
        class="lg:col-span-2"
        :base="{ name: 'admin-dashboard' }"
        :pages="[{ name: 'Profiles', to: { name: 'admin-profiles' } }]"
      >
        <CogIcon class="w-6 h-6" />
      </BreadcrumbsBar>
      <TableGenerator
        :head="[
          { name: 'Name', key: 'name' },
          { name: 'E-Mail', key: 'email' },
          { name: 'Phone', key: 'phone_number' },
          { name: '', key: 'action' },
        ]"
        :data="profiles"
      >
        <template #name="slotProps">
          <ButtonLink
            :to="{
              name: 'admin-profile',
              params: { id: slotProps.id },
            }"
          >
            {{ slotProps.name }}
          </ButtonLink>
        </template>
        <template #action="slotProps">
          <div class="flex justify-end space-x-3">
            <ButtonNormal
              v-if="!slotProps.accepted"
              size="xs"
              kind="action"
              @click="
                profile = slotProps;
                acceptUserModalOpen = true;
              "
            >
              Accept
            </ButtonNormal>
            <ButtonNormal
              v-if="slotProps.locked"
              size="xs"
              kind="action"
              @click="
                profile = slotProps;
                unlockUserModalOpen = true;
              "
            >
              Unlock
            </ButtonNormal>
            <ButtonNormal
              size="xs"
              kind="delete"
              @click="
                profile = slotProps;
                activateUserModalOpen = true;
              "
            >
              {{ slotProps.is_active ? "Deactivate" : "Activate" }}
            </ButtonNormal>
            <ButtonNormal
              size="xs"
              kind="delete"
              @click="
                profile = slotProps;
                deleteModalOpen = true;
              "
            >
              Delete
            </ButtonNormal>
          </div>
        </template>
      </TableGenerator>
    </div>
    <!-- delete -->
    <ModalDelete
      v-model="deleteModalOpen"
      :request="deleteRequest"
      :object="profile"
    />
    <!-- accept -->
    <ModalConfirm
      v-model="acceptUserModalOpen"
      title="Accept User"
      :request="acceptUserRequest"
      :data="{ user: profile?.id }"
    >
      Are your sure you want to accept '{{ profile?.name }}'?
    </ModalConfirm>
    <!-- unlock -->
    <ModalDelete
      v-model="unlockUserModalOpen"
      title="Unlock User"
      :request="unlockUserRequest"
      :object="profile"
      verb="unlock"
    />
    <ModalDelete
      v-model="activateUserModalOpen"
      :title="
        profile && profile.is_active ? 'Deactivate user' : 'Activate user'
      "
      :request="activateUserRequest"
      :object="
        Object.assign({}, profile, { is_active: profile && !profile.is_active })
      "
      :verb="profile && profile.is_active ? 'deactivate' : 'activate'"
    />
  </BoxLoader>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { ref, Ref } from "vue";
import { RlcUserSmall } from "@/types/user";
import useGet from "@/composables/useGet";
import AdminService from "@/services/admin";
import BoxLoader from "@/components/BoxLoader.vue";
import { ModalConfirm, TableGenerator } from "@lawandorga/components";
import { ButtonNormal } from "@lawandorga/components";
import useUpdate from "@/composables/useUpdate";
import useDelete from "@/composables/useDelete";
import { ModalDelete } from "@lawandorga/components";
import BreadcrumbsBar from "@/components/BreadcrumbsBar.vue";
import { CogIcon } from "@heroicons/vue/24/outline";
import ButtonLink from "@/components/ButtonLink.vue";
import useCommand from "@/composables/useCommand";

export default defineComponent({
  components: {
    ButtonLink,
    BreadcrumbsBar,
    CogIcon,
    BoxLoader,
    TableGenerator,
    ButtonNormal,
    ModalDelete,
    ModalConfirm,
  },
  setup() {
    const profiles = ref(null) as Ref<RlcUserSmall[] | null>;
    const query = useGet(AdminService.getUsers, profiles);

    // accept
    const {
      commandRequest: acceptUserRequest,
      commandModalOpen: acceptUserModalOpen,
    } = useCommand(AdminService.acceptUser, query);

    // delete
    const profile = ref(null) as Ref<RlcUserSmall | null>;
    const { deleteRequest, deleteModalOpen } = useDelete(
      AdminService.deleteUser,
      profiles,
    );

    // unlock
    const {
      updateRequest: unlockUserRequest,
      updateModalOpen: unlockUserModalOpen,
    } = useUpdate(AdminService.unlockUser, profiles);

    // activate
    const {
      updateRequest: activateUserRequest,
      updateModalOpen: activateUserModalOpen,
    } = useUpdate(AdminService.activateUser, profiles);

    return {
      profiles,
      profile,
      // delete
      deleteRequest,
      deleteModalOpen,
      // accept
      acceptUserRequest,
      acceptUserModalOpen,
      // unlock
      unlockUserRequest,
      unlockUserModalOpen,
      // activate
      activateUserRequest,
      activateUserModalOpen,
    };
  },
});
</script>
